<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>{{tituloPagina}}</title>
  <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
  <header>
    <div class="logo">Mi Ecommerce</div>

    <nav>
      <a href="/">Inicio</a>
      <a href="/products">Productos</a>
      <a href="/realtimeproducts">Tiempo real</a>

      {{!-- Links seg煤n sesi贸n --}}
      {{#if usuario}}
        <a href="#" id="btn-logout">Cerrar sesi贸n</a>
      {{else}}
        <a href="/login">Iniciar sesi贸n</a>
        <a href="/register">Registrarse</a>
      {{/if}}

      {{!-- Link del carrito: si hay usuario, usa su carritoId --}}
      {{#if usuario}}
        <a href="/carts/{{usuario.carritoId}}" class="cart-icon" id="link-carrito">
           Carrito
        </a>
      {{else}}
        <a href="/login" class="cart-icon" id="link-carrito">
           Carrito
        </a>
      {{/if}}
    </nav>
  </header>

  <main>
    {{#if usuario}}
      <p class="saludo">Hola, {{usuario.nombre}} </p>
    {{/if}}

    {{{body}}}
  </main>

  <script>
    (function () {
      // Si no hay sesi贸n, no intentamos pedir el carrito
      const idCarrito = "{{#if usuario}}{{usuario.carritoId}}{{/if}}";
      if (!idCarrito) return;

      const link = document.getElementById("link-carrito");
      if (!link) return;

      fetch(`/api/carts/${idCarrito}`)
        .then(function (res) {
          if (!res.ok) return null; // si es 401, no rompe el script
          return res.json();
        })
        .then(function (data) {
          if (!data || !Array.isArray(data.products)) return;

          const total = data.products.reduce(function (acc, item) {
            return acc + (item.quantity || 0);
          }, 0);

          if (total > 0) {
            link.textContent = ` Carrito (${total})`;
          } else {
            link.textContent = " Carrito";
          }
        })
        .catch(function (error) {
          console.log("No se pudo obtener el carrito:", error);
        });
    })();

    (function () {
      const btn = document.getElementById("btn-logout");
      if (!btn) return;

      btn.addEventListener("click", function (e) {
        e.preventDefault();

        fetch("/api/sessions/logout", { method: "POST" })
          .then(function () {
            window.location.href = "/login";
          })
          .catch(function () {
            window.location.href = "/login";
          });
      });
    })();
  </script>
</body>
</html>
