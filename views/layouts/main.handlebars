<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>{{tituloPagina}}</title>
  <link rel="stylesheet" href="/public/css/style.css">
</head>
<body>
  <header>
    <div class="logo">Mi Ecommerce</div>

    <nav>
      <a href="/">Inicio</a>
      <a href="/products">Productos</a>
      <a href="/realtimeproducts">Tiempo real</a>

      {{!-- Links segÃºn sesiÃ³n --}}
      {{#if usuario}}
        <a href="#" id="btn-logout">Cerrar sesiÃ³n</a>
      {{else}}
        <a href="/login">Iniciar sesiÃ³n</a>
        <a href="/register">Registrarse</a>
      {{/if}}

      {{!-- Link del carrito --}}
      {{#if usuario}}
        <a href="/carts/{{usuario.cart}}" class="cart-icon" id="link-carrito">
          ðŸ›’ Carrito
        </a>
      {{else}}
        <a href="/login" class="cart-icon" id="link-carrito">
          ðŸ›’ Carrito
        </a>
      {{/if}}
    </nav>
  </header>

  <main>
    {{#if usuario}}
      <p class="saludo">Hola, {{usuario.first_name}} ðŸ‘‹</p>
    {{/if}}

    {{{body}}}
  </main>

  <script>
    (function () {
      const idCarrito = "{{#if usuario}}{{usuario.cart}}{{/if}}";
      if (!idCarrito) return;

      const link = document.getElementById("link-carrito");
      if (!link) return;

      fetch(`/api/carts/${idCarrito}`)
        .then(function (res) {
          if (!res.ok) return null;
          return res.json();
        })
        .then(function (data) {
          const carrito = data && data.payload ? data.payload : data;
          if (!carrito || !Array.isArray(carrito.products)) return;

          const total = carrito.products.reduce(function (acc, item) {
            return acc + (item.quantity || 0);
          }, 0);

          link.textContent = total > 0
            ? `ðŸ›’ Carrito (${total})`
            : "ðŸ›’ Carrito";
        })
        .catch(function (error) {
          console.log("No se pudo obtener el carrito:", error);
        });
    })();

    (function () {
      const btn = document.getElementById("btn-logout");
      if (!btn) return;

      btn.addEventListener("click", function (e) {
        e.preventDefault();

        fetch("/api/sessions/logout", { method: "POST" })
          .then(function () {
            window.location.href = "/login";
          })
          .catch(function () {
            window.location.href = "/login";
          });
      });
    })();
  </script>
</body>
</html>
