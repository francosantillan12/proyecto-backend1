<h1>{{tituloPagina}}</h1>

<h2>Carrito</h2>
<p class="carrito-id">ID del carrito: {{carrito._id}}</p>

<!-- BotÃ³n para vaciar carrito -->
<button id="btn-vaciar" class="btn-vaciar">Vaciar carrito</button>

{{#if carrito.products.length}}
  <ul class="carrito-lista">
    {{#each carrito.products}}
      {{#if this.product}}
        <li class="carrito-card">
          <h3 class="producto-titulo">{{this.product.titulo}}</h3>

          <p class="producto-descripcion">
            {{this.product.descripcion}}
          </p>

          <p class="producto-detalle">
            <span class="precio">ðŸ’° $ {{this.product.precio}}</span>
            <span class="categoria">ðŸ¥« {{this.product.categoria}}</span>
            <span class="stock">ðŸ“¦ Stock: {{this.product.stock}}</span>
            <span class="cantidad">ðŸ›’ Cantidad en carrito: {{this.quantity}}</span>
          </p>

          <button
            class="btn-eliminar"
            data-pid="{{this.product._id}}"
          >
            Eliminar del carrito
          </button>
        </li>
      {{/if}}
    {{/each}}
  </ul>
{{else}}
  <p>El carrito estÃ¡ vacÃ­o.</p>
{{/if}}

<script>
  const idCarrito = "{{carrito._id}}";

  /* ================================
     ELIMINAR UN SOLO PRODUCTO
     ================================ */
  const botonesEliminar = document.querySelectorAll(".btn-eliminar");

  botonesEliminar.forEach(function (boton) {
    boton.addEventListener("click", function () {
      const idProducto = boton.dataset.pid;

      fetch(`/api/carts/${idCarrito}/products/${idProducto}`, {
        method: "DELETE"
      })
        .then(res => res.json())
        .then(() => {
          alert("Producto eliminado del carrito");
          location.reload();
        })
        .catch(error => {
          console.log("Error al eliminar producto:", error);
          alert("No se pudo eliminar el producto");
        });
    });
  });

  /* ================================
     VACIAR CARRITO COMPLETO
     ================================ */
  const btnVaciar = document.getElementById("btn-vaciar");

  if (btnVaciar) {
    btnVaciar.addEventListener("click", function () {
      if (!confirm("Â¿Seguro que querÃ©s vaciar TODO el carrito?")) return;

      fetch(`/api/carts/${idCarrito}`, {
        method: "DELETE"
      })
        .then(res => res.json())
        .then(() => {
          alert("Carrito vaciado");
          location.reload();
        })
        .catch(error => {
          console.log("Error al vaciar carrito:", error);
          alert("No se pudo vaciar el carrito");
        });
    });
  }
</script>
